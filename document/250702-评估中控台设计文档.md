# 250702-评估中控台设计文档

## 一、背景与目标

为系统性评估RAG系统的检索与生成效果，需开发一个评估中控台（eval dashboard），支持embedding效果评估与最终生成答案效果评估两大类任务，便于快速定位和量化系统瓶颈。

---

## 二、功能概述

### 1. 支持两大评估模式
- **Embedding效果评估**：通过embedding可视化、相似度分布分析等手段，衡量embedding模型与业务场景的匹配度。
- **最终答案效果评估**：对比系统生成答案与标准答案，统计召回/准确率等指标。

### 2. 输入输出
- **输入**：
  - 一个csv文件，第一列为query，后续可扩展为多列（如标准答案、标签等）。
  - 评估模式参数（embedding/answer）。
- **输出**：
  - 评估报告（图表、统计数据、可视化结果等）。
  - 详细日志与中间结果。

---

## 三、主要流程

### 1. 评估模式选择
- 用户通过命令行参数或配置文件指定评估模式（embedding/answer）。

### 2. 数据加载
- 读取csv文件，获取query及相关字段。

### 3. Embedding效果评估流程
- 对每个query生成embedding。
- 可选：对标准答案/知识库chunk也生成embedding。
- 计算query与标准答案、query与知识库其他chunk的相似度分布。
- 使用t-SNE/UMAP等方法降维可视化embedding分布。
- 输出：
  - 相似度分布直方图
  - embedding二维分布图
  - 典型case分析表

### 4. 最终答案效果评估流程
- 对每个query运行RAG系统，获取生成答案。
- 与标准答案比对，计算召回率、准确率等指标。
- 输出：
  - 评测指标表
  - 错误case明细

---

## 四、可扩展性设计
- 支持多种embedding模型、评测指标、可视化方式的插件式扩展。
- 支持批量评测与单条case深度分析。
- 评估结果可导出为markdown、csv、图片等多种格式。

---

## 五、目录结构建议

evaltool/
  ├── 评估中控台主程序（如eval_dashboard.py）
  ├── embedding评估模块（embedding_eval.py）
  ├── 答案评估模块（answer_eval.py）
  ├── 可视化工具（visualization.py）
  ├── 示例csv与输出样例
  └── 设计文档（本文件）

---

## 六、后续可扩展方向
- 支持多模型对比评测
- 支持自动化批量测试与定期评估
- 支持web可视化界面

---

## 七、各模块具体实现方案

### 1. 评估中控台主程序（eval_dashboard.py）
- **主要功能**：
  - 解析命令行参数或配置文件，选择评估模式（embedding/answer）。
  - 调用对应评估模块，组织评估流程。
  - 汇总评估结果，生成报告。
- **输入输出**：
  - 输入：csv文件路径、评估模式、可选参数（如embedding模型名、top_k等）。
  - 输出：评估报告（markdown、csv、图片等）。
- **实现建议**：
  - 使用argparse或click实现命令行参数解析。
  - 采用模块化结构，便于扩展新评估方法。

### 2. embedding评估模块（embedding_eval.py）
- **主要功能**：
  - 加载embedding模型（支持多种模型，优先从配置文件和os.getenv读取模型名）。
  - 对query、标准答案、知识库chunk生成embedding。
  - 计算相似度分布（如余弦相似度），输出典型case分析表。
  - 调用可视化工具生成embedding分布图、相似度直方图。
- **输入输出**：
  - 输入：query列表、标准答案、知识库chunk、embedding模型名。
  - 输出：相似度分布表、可视化图片、分析报告。
- **关键技术点**：
  - 支持批量embedding生成，兼容本地和API方式。
  - 支持多模型对比。
  - 可选：支持embedding缓存，提升效率。

### 3. 答案评估模块（answer_eval.py）
- **主要功能**：
  - 调用RAG主流程，对每个query生成答案。
  - 与标准答案比对，计算召回率、准确率、F1等指标。
  - 输出错误case明细，便于后续分析。
- **输入输出**：
  - 输入：query列表、标准答案、RAG系统接口参数。
  - 输出：评测指标表、错误case明细、分析报告。
- **关键技术点**：
  - 支持多种比对方式（全匹配、部分匹配、embedding相似度等）。
  - 支持批量评测与单条case分析。

### 4. 可视化工具（visualization.py）
- **主要功能**：
  - 提供embedding降维（t-SNE/UMAP）、相似度分布直方图、case分析表等可视化方法。
  - 支持结果导出为图片、markdown嵌入等。
- **输入输出**：
  - 输入：embedding向量、相似度分布、case分析数据。
  - 输出：图片文件、可嵌入markdown的图表。
- **关键技术点**：
  - 推荐使用matplotlib、seaborn、plotly等主流可视化库。
  - 降维算法可用sklearn、umap-learn等。

### 5. 配置与常量管理
- **建议**：
  - embedding模型名、RAG接口地址、top_k等参数优先从.env和config.py读取，避免硬编码。
  - 支持通过环境变量灵活切换评估环境。

### 6. 示例csv与输出样例
- **建议**：
  - 提供标准格式的csv模板，便于用户快速上手。
  - 提供典型评估报告样例，帮助理解评估结果。

---

如需某一模块的详细代码模板或具体实现细节，可随时补充。 