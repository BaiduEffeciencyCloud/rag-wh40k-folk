# 250705 Sparse向量分析工具设计文档

## 1. 项目概述

### 1.1 目标
创建一个评估工具，用于分析chunk的sparse向量生成情况，识别sparse值为空的chunk，帮助优化BM25参数配置。

### 1.2 功能需求
- 支持动态调整BM25参数（min_freq, max_vocab_size）
- 自动调用gen_userdict.py重新生成词典
- 批量分析chunk文件的sparse向量生成
- 识别并收集sparse值为空的chunk
- 生成详细的分析报告JSON

### 1.3 使用场景
- 调试"Sparse vector must contain at least one value"错误
- 优化BM25参数配置
- 分析chunk质量
- 评估词典覆盖度

## 2. 系统架构

### 2.1 文件结构
```
evaltool/
├── sparse_analyzer.py          # 主分析类
├── config_manager.py           # 参数配置管理
├── chunk_processor.py          # chunk处理逻辑
├── report_generator.py         # 报告生成器
└── main.py                     # 命令行入口
```

### 2.2 核心类设计

#### 2.2.1 SparseAnalyzer类
```python
class SparseAnalyzer:
    def __init__(self, config: SparseAnalyzerConfig):
        self.config = config
        self.bm25_manager = None
        self.results = []
    
    def analyze_chunks(self, chunk_file_path: str) -> AnalysisResult:
        """分析chunk文件的sparse向量生成情况"""
        
    def adjust_bm25_params(self, min_freq: int, max_vocab_size: int):
        """调整BM25参数并重新生成词典"""
        
    def generate_report(self) -> dict:
        """生成分析报告"""
```

#### 2.2.2 SparseAnalyzerConfig类
```python
class SparseAnalyzerConfig:
    def __init__(self):
        self.min_freq = 5
        self.max_vocab_size = 10000
        self.input_dir = "data"  # 词典生成的输入目录
        self.output_dir = "dict"  # 词典输出目录
        self.gen_userdict_path = "dataupload/gen_userdict.py"
        self.report_output_path = "evaltool/sparse_analysis_report.json"
```

## 3. 详细设计

### 3.1 参数调整流程
1. **接收新参数**：min_freq, max_vocab_size
2. **临时设置环境变量**：通过`os.environ`临时覆写`BM25_MIN_FREQ`, `BM25_MAX_VOCAB_SIZE`（不修改config.py默认值）
3. **调用gen_userdict.py**：重新生成词典
4. **验证词典生成**：检查新词典文件是否存在
5. **恢复环境变量**：分析完成后恢复原始环境变量设置

### 3.2 Chunk分析流程
1. **加载chunk文件**：读取JSON格式的chunk数据（data_vector_v3.py生成的格式）
2. **初始化BM25Manager**：使用新生成的词典
3. **逐个分析chunk**：
   - 提取chunk文本（从`text`字段）
   - 可选：结合标题信息（`section_heading`, `h1`-`h6`）增强词汇覆盖
   - 调用BM25Manager.get_sparse_vector()
   - 记录sparse向量结果
   - 识别空sparse向量的chunk
4. **统计结果**：计算各种统计指标

### 3.3 Chunk格式说明
根据`data_vector_v3.py`的`_create_chunk_metadata`方法，chunk结构为：
```python
{
    'text': str,                    # 主要文本内容（用于sparse向量生成）
    'section_heading': str,         # 章节标题
    'chunk_type': str,              # 切片类型
    'content_type': str,            # 内容类型
    'faction': str,                 # 派系
    'h1': str, 'h2': str, ..., 'h6': str,  # 标题层级
    # 可能还有其他extra_metadata字段
}
```

### 3.4 报告生成格式
```json
{
  "analysis_config": {
    "min_freq": 5,
    "max_vocab_size": 10000,
    "analysis_time": "2025-07-05T18:00:00",
    "chunk_file_path": "dataupload/chunks/xxx.json"
  },
  "bm25_stats": {
    "vocabulary_size": 462,
    "model_path": "models/bm25_model.pkl",
    "vocab_path": "dict/bm25_vocab_xxx.json",
    "userdict_path": "dict/all_docs_dict_xxx.txt"
  },
  "chunk_analysis": {
    "total_chunks": 150,
    "chunks_with_sparse": 120,
    "chunks_without_sparse": 30,
    "sparse_coverage_rate": 0.8
  },
  "empty_sparse_chunks": [
    {
      "chunk_id": "file1-15",
      "text": "原始文本内容",
      "text_length": 45,
      "tokens": ["分词", "结果"],
      "reason": "所有词汇都不在BM25词汇表中"
    }
  ],
  "sparse_vector_stats": {
    "avg_indices_count": 3.2,
    "max_indices_count": 12,
    "min_indices_count": 0,
    "avg_weight": 1.85,
    "weight_distribution": {
      "0-1": 25,
      "1-2": 45,
      "2-3": 30,
      "3+": 20
    }
  }
}
```

## 4. 实现细节

### 4.1 环境变量管理
```python
def set_bm25_env_vars(min_freq: int, max_vocab_size: int):
    """临时设置BM25环境变量（不修改config.py默认值）"""
    # 保存原始值
    original_min_freq = os.environ.get('BM25_MIN_FREQ')
    original_max_vocab_size = os.environ.get('BM25_MAX_VOCAB_SIZE')
    
    # 临时设置新值
    os.environ['BM25_MIN_FREQ'] = str(min_freq)
    os.environ['BM25_MAX_VOCAB_SIZE'] = str(max_vocab_size)
    
    return original_min_freq, original_max_vocab_size

def restore_bm25_env_vars(original_min_freq: str, original_max_vocab_size: str):
    """恢复原始环境变量设置"""
    if original_min_freq is not None:
        os.environ['BM25_MIN_FREQ'] = original_min_freq
    else:
        os.environ.pop('BM25_MIN_FREQ', None)
    
    if original_max_vocab_size is not None:
        os.environ['BM25_MAX_VOCAB_SIZE'] = original_max_vocab_size
    else:
        os.environ.pop('BM25_MAX_VOCAB_SIZE', None)
```

### 4.2 词典生成调用
```python
def regenerate_userdict(self):
    cmd = f"python3 {self.config.gen_userdict_path} --input-dir {self.config.input_dir} --output-dir {self.config.output_dir} --filter"
    subprocess.run(cmd, shell=True, check=True)
```

### 4.3 Chunk文本提取
```python
def extract_chunk_text(self, chunk: dict, include_headers: bool = True) -> str:
    """从chunk中提取用于sparse向量生成的文本"""
    text = chunk.get('text', '')
    
    if include_headers:
        # 可选：添加标题信息增强词汇覆盖
        section_heading = chunk.get('section_heading', '')
        headers = []
        for i in range(1, 7):
            header = chunk.get(f'h{i}', '')
            if header:
                headers.append(header)
        
        if headers:
            text = f"{' '.join(headers)} {text}"
    
    return text
```

### 4.4 空sparse向量识别
```python
def is_empty_sparse_vector(self, sparse_vector: dict) -> bool:
    """判断sparse向量是否为空"""
    if not sparse_vector:
        return True
    indices = sparse_vector.get('indices', [])
    return len(indices) == 0
```

## 5. 使用示例

### 5.1 命令行使用
```bash
# 使用默认参数分析
python3 evaltool/main.py --chunk-file dataupload/chunks/xxx.json

# 调整参数后分析
python3 evaltool/main.py --chunk-file dataupload/chunks/xxx.json --min-freq 2 --max-vocab-size 5000

# 指定输出报告路径
python3 evaltool/main.py --chunk-file dataupload/chunks/xxx.json --output evaltool/custom_report.json
```

### 5.2 编程接口使用
```python
from evaltool.sparse_analyzer import SparseAnalyzer, SparseAnalyzerConfig

# 创建配置
config = SparseAnalyzerConfig()
config.min_freq = 2
config.max_vocab_size = 5000

# 创建分析器
analyzer = SparseAnalyzer(config)

# 分析chunk文件
result = analyzer.analyze_chunks("dataupload/chunks/xxx.json")

# 生成报告
report = analyzer.generate_report()
print(f"空sparse向量的chunk数量: {len(report['empty_sparse_chunks'])}")
```

## 6. 输出分析

### 6.1 关键指标
- **sparse覆盖率**：有sparse向量的chunk比例
- **平均词汇数**：每个chunk的平均sparse向量维度
- **权重分布**：sparse向量权重的分布情况
- **问题chunk分析**：空sparse向量的chunk特征

### 6.2 优化建议
- 如果sparse覆盖率低，建议降低min_freq
- 如果词汇数过少，建议增加max_vocab_size
- 分析空sparse向量的chunk内容，优化分词规则

## 7. 扩展功能

### 7.1 批量参数测试
支持多组参数配置的批量测试，找出最优参数组合。

### 7.2 可视化报告
生成图表展示sparse向量分布情况。

### 7.3 自动优化建议
基于分析结果自动推荐参数调整方案。

## 8. 注意事项

### 8.1 性能考虑
- 大量chunk分析时考虑分批处理
- 词典重新生成可能耗时较长

### 8.2 错误处理
- 词典生成失败的处理
- chunk文件格式错误的处理
- BM25模型加载失败的处理

### 8.3 兼容性
- 支持不同格式的chunk文件
- 兼容不同版本的gen_userdict.py

---

**文档生成时间：250705** 