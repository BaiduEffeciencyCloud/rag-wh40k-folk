# 250703-向量化上传时支持hybrid检索的工程处理（补充于250703）

## 一、背景

随着RAG系统对检索召回率和业务覆盖的要求提升，单一dense向量检索已难以满足复杂场景。Pinecone官方hybrid检索方案支持同时利用dense（语义）和sparse（关键词）向量，显著提升召回效果。当前工程仅上传dense向量，未利用hybrid能力，需进行全链路改造。

## 二、目标

- 支持向Pinecone索引批量上传时，同时写入dense和sparse向量，实现hybrid检索能力。
- 保证兼容现有纯dense检索流程，便于平滑切换和A/B测试。
- 方案可扩展，便于后续支持多种sparse embedding模型。

## 三、方案设计

### 1. Pinecone索引要求
- 必须使用`vector_type="dense"`且`metric="dotproduct"`的index。
- dimension需与本地embedding模型一致。

### 2. 数据上传结构
- 每条向量数据需包含：
  - `id`: 唯一标识
  - `values`: dense向量（如OpenAI、Llama等）
  - `sparse_values`: sparse向量（如BM25、SPLADE、pinecone-sparse-english-v0等，格式为`{"indices": List[int], "values": List[float]}`）
  - `metadata`: 元数据

### 3. sparse向量生成
- 推荐使用官方或社区sparse embedding模型（如pinecone-sparse-english-v0、BM25/SPLADE等）。
- 支持本地生成或调用API。
- indices必须为int类型，values为float。

### 4. 代码实现要点
- 在`upsert.py`的向量化流程中，新增sparse embedding生成逻辑：
  1. 对每个chunk文本，先生成dense embedding，再生成sparse embedding。
  2. 组装upsert数据时，增加`sparse_values`字段。
  3. 调用`self.pinecone_index.upsert(vectors=batch)`时，batch内每条数据均含`sparse_values`。
- 兼容无sparse embedding时的降级处理（如仅上传dense）。

### 5. 兼容性与配置
- embedding模型、sparse模型、index名称、dimension等均通过config.py和.env统一配置。
- 支持通过开关参数控制是否启用hybrid上传。

## 四、注意事项

- sparse embedding的indices类型必须为int，否则Pinecone会报错。
- hybrid检索仅在dotproduct metric下生效。
- 若sparse embedding生成失败，需有降级/兜底策略，避免批量上传失败。
- 上传前建议对dense/sparse维度、类型做一致性校验。

## 五、落地建议

1. 优先在测试环境验证hybrid上传与检索全链路。
2. 逐步切换线上索引为dotproduct metric，确保兼容性。
3. 评估不同sparse embedding模型对业务效果的提升，结合评测工具做A/B实验。
4. 持续沉淀工程经验与最佳实践，完善文档与自动化测试。

## 工程实现要点（250703补充）

1. **BM25Manager实现**：
   - 独立bm25_manager.py，支持fit/增量更新/稀疏向量生成/保存加载，全部参数通过config.py和.env管理。
   - 稀疏向量严格按BM25公式，词表剪枝、增量更新用原始文本，避免token当文档。

2. **hybrid_search集成**：
   - vector_search.py中调用BM25Manager.get_sparse_vector生成稀疏向量，hybrid_scale方法支持alpha加权。
   - 检索、upsert、索引等全部参数通过config.py读取，禁止hardcode。

3. **配置项统一**：
   - 新增BM25_K1、BM25_B、BM25_MIN_FREQ等全部通过os.getenv()，并在config.py集中管理。

4. **测试用例**：
   - test_hybrid_search.py覆盖稀疏向量正确性、增量更新、hybrid_scale、异常处理等。

5. **最佳实践**：
   - 代码与文档均补丁式修订，所有magic number、KEY、模型名等均走配置文件，便于review和工程落地。

（250703补充，详见hybrid检索设计文档及补丁）

---

如需详细代码模板或遇到具体实现问题，可随时补充！ 