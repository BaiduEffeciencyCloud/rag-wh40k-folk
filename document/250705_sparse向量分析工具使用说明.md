# Sparse向量分析工具使用说明

**生成时间**: 2024-12-01  
**工具版本**: 1.0.0

## 概述

Sparse向量分析工具用于分析chunk文件中sparse向量生成情况，支持动态调整BM25参数，识别空sparse向量并生成详细报告。

## 功能特性

- 🔍 **动态参数调整**: 支持临时调整BM25的min_freq和max_vocab_size参数
- 📊 **详细分析**: 分析chunk文本特征、sparse向量统计、词汇表覆盖率
- 🎯 **空向量识别**: 自动识别并分析空sparse向量的原因
- 📈 **智能建议**: 基于分析结果生成改进建议
- 📝 **完整报告**: 生成JSON格式的详细分析报告

## 安装依赖

确保已安装以下Python包：
```bash
pip3 install jieba
```

## 使用方法

### 基本用法

```bash
# 使用默认参数分析
python3 evaltool/analyze_sparse.py data/chunks.json

# 调整BM25参数
python3 evaltool/analyze_sparse.py data/chunks.json --min_freq 3 --max_vocab 15000

# 使用现有词典（不重新生成）
python3 evaltool/analyze_sparse.py data/chunks.json --no_gen_dict

# 指定输出报告路径
python3 evaltool/analyze_sparse.py data/chunks.json --output report.json
```

### 命令行参数

| 参数 | 简写 | 类型 | 默认值 | 说明 |
|------|------|------|--------|------|
| `chunk_file` | - | 文件路径 | 必需 | chunk文件路径 |
| `--min_freq` | `-mf` | 整数 | 5 | 最小词频 |
| `--max_vocab` | `-mv` | 整数 | 10000 | 最大词汇表大小 |
| `--no_gen_dict` | `-ngd` | 标志 | False | 不重新生成词典 |
| `--output` | `-o` | 文件路径 | evaltool/sparse_analysis_report.json | 输出报告路径 |
| `--no_headers` | `-nh` | 标志 | False | 不包含标题信息 |
| `--verbose` | `-v` | 标志 | False | 详细输出 |

## 输出报告格式

分析完成后会生成JSON格式的报告，包含以下部分：

### 1. 报告信息 (report_info)
```json
{
  "timestamp": "20241201_143022",
  "generated_at": "2024-12-01T14:30:22",
  "tool_version": "1.0.0"
}
```

### 2. 配置信息 (configuration)
```json
{
  "min_freq": 5,
  "max_vocab_size": 10000,
  "include_headers": true,
  "dict_file": "dict/userdict_20241201_143022.json"
}
```

### 3. 摘要信息 (summary)
```json
{
  "total_chunks": 1000,
  "empty_sparse_count": 50,
  "empty_sparse_rate": 0.05,
  "vocabulary_size": 5000,
  "vocab_coverage_rate": 0.85
}
```

### 4. 详细分析 (detailed_analysis)
- **sparse_vector_stats**: sparse向量统计信息
- **vocabulary_stats**: 词汇表统计信息
- **vocabulary_coverage**: 词汇表覆盖率分析
- **empty_sparse_chunks**: 空sparse向量的chunk列表

### 5. 改进建议 (recommendations)
```json
[
  "空sparse向量比例较高(15.00%)，建议调整BM25参数",
  "词汇覆盖率较低(45.00%)，建议降低min_freq或增加max_vocab_size"
]
```

## 使用示例

### 示例1: 基础分析
```bash
python3 evaltool/analyze_sparse.py data/chunks.json
```

输出示例：
```
开始分析chunk文件: data/chunks.json
配置: min_freq=5, max_vocab_size=10000
包含标题: True
生成新词典: True

============================================================
SPARSE向量分析报告摘要
============================================================
总chunk数量: 1000
空sparse向量数量: 50
空sparse向量比例: 5.00%
词汇表大小: 5000
词汇覆盖率: 85.00%

改进建议:
  1. 当前配置表现良好，无需调整
============================================================

详细报告已保存到: evaltool/sparse_analysis_report.json
```

### 示例2: 参数调优
```bash
python3 evaltool/analyze_sparse.py data/chunks.json --min_freq 3 --max_vocab 15000 --verbose
```

### 示例3: 使用现有词典
```bash
python3 evaltool/analyze_sparse.py data/chunks.json --no_gen_dict --output custom_report.json
```

## 分析指标说明

### 空sparse向量比例
- **目标**: < 10%
- **含义**: 无法生成sparse向量的chunk比例
- **改进**: 降低min_freq或增加max_vocab_size

### 词汇表覆盖率
- **目标**: > 70%
- **含义**: chunk中词汇在BM25词汇表中的覆盖率
- **改进**: 降低min_freq或增加max_vocab_size

### 词汇表大小
- **推荐范围**: 1000-50000
- **过小**: 词汇覆盖率低，空向量多
- **过大**: 计算开销大，可能过拟合

## 故障排除

### 常见问题

1. **找不到chunk文件**
   ```
   错误: chunk文件不存在: data/chunks.json
   ```
   **解决**: 检查文件路径是否正确

2. **词典生成失败**
   ```
   生成词典失败: [错误信息]
   ```
   **解决**: 检查data目录是否存在，确保有足够的输入文件

3. **模块导入错误**
   ```
   无法导入BM25Manager模块
   ```
   **解决**: 确保在项目根目录运行，或设置PYTHONPATH

### 调试模式

使用`--verbose`参数获取详细日志：
```bash
python3 evaltool/analyze_sparse.py data/chunks.json --verbose
```

## 技术架构

工具采用模块化设计，包含以下核心组件：

- **SparseAnalyzerConfig**: 配置管理
- **ChunkProcessor**: chunk处理和文本分析
- **BM25Manager**: BM25词典生成和向量计算
- **SparseAnalyzer**: 主分析器，整合所有功能

## 版本历史

- **v1.0.0** (2024-12-01): 初始版本，支持基础sparse向量分析功能 