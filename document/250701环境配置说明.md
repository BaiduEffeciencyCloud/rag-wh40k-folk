# 知识图谱环境配置说明

## 概述

为了确保测试数据和生产数据的完全分离，我们实现了环境隔离机制。系统支持三种环境：

- **production**: 生产环境
- **test**: 测试环境  
- **development**: 开发环境

## 环境变量配置

### 生产环境配置
```bash
# 生产环境Neo4j配置
export NEO4J_URI="bolt://localhost:7687"
export NEO4J_USERNAME="neo4j"
export NEO4J_PASSWORD="your_production_password"
export NEO4J_DATABASE="wh40k_knowledge_graph"
```

### 测试环境配置
```bash
# 测试环境Neo4j配置
export NEO4J_TEST_URI="bolt://localhost:7687"
export NEO4J_TEST_USERNAME="neo4j"
export NEO4J_TEST_PASSWORD="your_test_password"
export NEO4J_TEST_DATABASE="test_wh40k_kg"
```

### 开发环境配置
```bash
# 开发环境Neo4j配置
export NEO4J_DEV_URI="bolt://localhost:7687"
export NEO4J_DEV_USERNAME="neo4j"
export NEO4J_DEV_PASSWORD="your_dev_password"
export NEO4J_DEV_DATABASE="dev_wh40k_kg"
```

## 环境隔离机制

### 节点标签隔离
- **生产环境**: `Unit`, `Skill`, `Weapon`, `Phase`, `Rule`
- **测试环境**: `test_Unit`, `test_Skill`, `test_Weapon`, `test_Phase`, `test_Rule`
- **开发环境**: `dev_Unit`, `dev_Skill`, `dev_Weapon`, `dev_Phase`, `dev_Rule`

### 关系类型隔离
- **生产环境**: `HAS_SKILL`, `EQUIPPED_WITH`, `ACTIVATES_IN`, `ALIAS_OF`
- **测试环境**: `test_HAS_SKILL`, `test_EQUIPPED_WITH`, `test_ACTIVATES_IN`, `test_ALIAS_OF`
- **开发环境**: `dev_HAS_SKILL`, `dev_EQUIPPED_WITH`, `dev_ACTIVATES_IN`, `dev_ALIAS_OF`

### 节点属性隔离
所有节点都包含 `environment` 属性，用于进一步隔离：
```cypher
// 生产环境节点
CREATE (u:Unit {name: "丑角剧团", environment: "production"})

// 测试环境节点  
CREATE (u:test_Unit {name: "丑角剧团", environment: "test"})

// 开发环境节点
CREATE (u:dev_Unit {name: "丑角剧团", environment: "development"})
```

## 使用方法

### 1. 命令行使用
```bash
# 生产环境
python3 data_vector_v3.py test_file.md production

# 测试环境
python3 data_vector_v3.py test_file.md test

# 开发环境
python3 data_vector_v3.py test_file.md development
```

### 2. 代码中使用
```python
from data_vector_v3 import SemanticDocumentChunker

# 生产环境
chunker = SemanticDocumentChunker(
    enable_knowledge_graph=True,
    environment="production"
)

# 测试环境
chunker = SemanticDocumentChunker(
    enable_knowledge_graph=True,
    environment="test"
)

# 开发环境
chunker = SemanticDocumentChunker(
    enable_knowledge_graph=True,
    environment="development"
)
```

### 3. 知识图谱管理器直接使用
```python
from knowledge_graph_manager import KnowledgeGraphManager

# 生产环境
kg_prod = KnowledgeGraphManager(environment="production")

# 测试环境
kg_test = KnowledgeGraphManager(environment="test")

# 开发环境
kg_dev = KnowledgeGraphManager(environment="development")
```

## 查询隔离

### 实体查询
```cypher
// 只查询生产环境实体
MATCH (e)
WHERE e.name CONTAINS "丑角剧团" AND e.environment = "production"
RETURN e

// 只查询测试环境实体
MATCH (e)
WHERE e.name CONTAINS "丑角剧团" AND e.environment = "test"
RETURN e
```

### 关系查询
```cypher
// 只查询生产环境关系
MATCH (a)-[r:HAS_SKILL]->(b)
WHERE a.environment = "production" AND b.environment = "production"
RETURN a, r, b

// 只查询测试环境关系
MATCH (a)-[r:test_HAS_SKILL]->(b)
WHERE a.environment = "test" AND b.environment = "test"
RETURN a, r, b
```

## 数据库设置建议

### 1. 单实例多数据库方案
```bash
# 在同一个Neo4j实例中创建不同数据库
CREATE DATABASE wh40k_knowledge_graph;
CREATE DATABASE test_wh40k_kg;
CREATE DATABASE dev_wh40k_kg;
```

### 2. 多实例方案
```bash
# 生产环境实例
NEO4J_URI="bolt://prod-neo4j:7687"

# 测试环境实例
NEO4J_TEST_URI="bolt://test-neo4j:7687"

# 开发环境实例
NEO4J_DEV_URI="bolt://dev-neo4j:7687"
```

### 3. Docker容器方案
```bash
# 生产环境容器
docker run -d --name neo4j-prod -p 7474:7474 -p 7687:7687 neo4j:latest

# 测试环境容器
docker run -d --name neo4j-test -p 7475:7474 -p 7688:7687 neo4j:latest

# 开发环境容器
docker run -d --name neo4j-dev -p 7476:7474 -p 7689:7687 neo4j:latest
```

## 最佳实践

### 1. 环境变量管理
```bash
# 创建环境配置文件
cat > .env.production << EOF
NEO4J_URI=bolt://prod-neo4j:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=prod_password
NEO4J_DATABASE=wh40k_knowledge_graph
EOF

cat > .env.test << EOF
NEO4J_TEST_URI=bolt://test-neo4j:7687
NEO4J_TEST_USERNAME=neo4j
NEO4J_TEST_PASSWORD=test_password
NEO4J_TEST_DATABASE=test_wh40k_kg
EOF
```

### 2. 数据清理
```cypher
// 清理测试环境数据
MATCH (n)
WHERE n.environment = "test"
DETACH DELETE n

// 清理开发环境数据
MATCH (n)
WHERE n.environment = "development"
DETACH DELETE n
```

### 3. 数据迁移
```cypher
// 从测试环境复制到生产环境（谨慎使用）
MATCH (n {environment: "test"})
CREATE (m:Unit)
SET m = n
SET m.environment = "production"
```

## 安全注意事项

1. **密码安全**: 使用强密码，定期更换
2. **网络隔离**: 生产环境数据库不应暴露在公网
3. **访问控制**: 为不同环境设置不同的用户权限
4. **备份策略**: 定期备份生产环境数据
5. **监控告警**: 监控数据库连接和性能

## 故障排除

### 1. 连接失败
```bash
# 检查Neo4j服务状态
systemctl status neo4j

# 检查端口是否开放
netstat -tlnp | grep 7687

# 检查防火墙设置
ufw status
```

### 2. 认证失败
```bash
# 重置Neo4j密码
cypher-shell -u neo4j -p neo4j
ALTER CURRENT USER SET PASSWORD FROM 'neo4j' TO 'new_password'
```

### 3. 数据库不存在
```cypher
// 创建数据库
CREATE DATABASE test_wh40k_kg;

// 切换到数据库
:use test_wh40k_kg;
```

## 总结

通过环境隔离机制，我们实现了：

1. **数据安全**: 测试数据不会污染生产数据
2. **开发效率**: 可以安全地进行测试和开发
3. **部署灵活**: 支持不同环境的独立部署
4. **维护简单**: 清晰的环境边界和配置管理

建议在开发过程中始终使用测试环境，只有在确认无误后才部署到生产环境。 