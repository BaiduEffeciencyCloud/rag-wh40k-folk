# 25-07-02 分层检索方案可行性分析

## 1. 方案概述

### 1.1 核心思路
由于Pinecone不支持部分匹配，我们提出了一种分层检索方案：
1. **第一层**：通过子query定位到1级或2级目录（如"战火军阵"、"凯恩化身"等）
2. **第二层**：在缩小范围内根据关键字进行向量召回
3. **优势**：避免全局检索，提高检索精度和效率

### 1.2 技术实现
- 使用Pinecone的metadata filter功能
- 利用h1~h6多级标题字段进行精确过滤
- 在过滤后的结果集中进行向量相似度检索

## 2. 测试结果分析

### 2.1 层级结构统计
从测试结果可以看出，当前数据集的层级结构如下：
- **h1**: 13个唯一标题（如"战场示例"、"丑角单位数据"等）
- **h2**: 7个唯一标题（如"规则注解"、"骑乘"等）
- **h3**: 11个唯一标题（如"剧团长"、"凯恩化身"等）

### 2.2 具体测试用例结果

#### 2.2.1 战火军阵测试
- **查询**: "战火军阵的规则是什么"
- **层级过滤**: `{"h2": {"$eq": "战火军阵 (WARHOST)"}}`
- **结果**:
  - 层级过滤找到3个结果，平均分数0.3801
  - 无过滤找到5个结果，平均分数0.5716
  - **问题**: 两种方式都未找到包含"战火军阵"的内容
  - **分析**: 可能是层级标题与实际内容不匹配

#### 2.2.2 凯恩化身测试
- **查询**: "凯恩化身的属性和技能"
- **层级过滤**: `{"h3": {"$eq": "凯恩化身 AVATAR OF KHAINE"}}`
- **结果**:
  - 层级过滤找到1个结果，平均分数0.4991，100%相关
  - 无过滤找到5个结果，平均分数0.4875，40%相关
  - **优势**: 层级过滤显著提高了相关性
  - **问题**: 召回数量较少

#### 2.2.3 猎鹰坦克测试
- **查询**: "猎鹰坦克的装备和运输能力"
- **层级过滤**: `{"h3": {"$eq": "猎鹰坦克 FALCON"}}`
- **结果**:
  - 层级过滤找到2个结果，平均分数0.4959，50%相关
  - 无过滤找到5个结果，平均分数0.5177，20%相关
  - **优势**: 层级过滤提高了相关性
  - **问题**: 召回数量仍然较少

## 3. 可行性评估

### 3.1 优势
1. **提高相关性**: 在凯恩化身和猎鹰坦克测试中，层级过滤显著提高了结果的相关性
2. **减少噪音**: 过滤掉了不相关的内容，提高了检索精度
3. **技术可行**: Pinecone的filter功能完全支持这种方案

### 3.2 挑战
1. **召回数量少**: 层级过滤后召回的结果数量较少，可能遗漏相关信息
2. **层级匹配问题**: 部分实体（如"战火军阵"）的层级标题与实际内容不匹配
3. **依赖精确匹配**: 需要用户输入的实体名与h1~h6字段完全匹配

### 3.3 改进建议

#### 3.3.1 实体标准化映射
```python
# 建立简写到全称的映射关系
entity_mapping = {
    "战火军阵": ["战火军阵 (WARHOST)", "WARHOST"],
    "凯恩化身": ["凯恩化身 AVATAR OF KHAINE", "AVATAR OF KHAINE"],
    "猎鹰坦克": ["猎鹰坦克 FALCON", "FALCON"],
    "司战": ["司战 AUTARCH", "AUTARCH"]
}
```

#### 3.3.2 多层级组合检索
```python
# 构建多层级$or查询
filter_conditions = []
for entity_name in entity_mapping.get(entity, [entity]):
    for i in range(1, 7):  # h1到h6
        filter_conditions.append({f"h{i}": {"$eq": entity_name}})

filter_dict = {"$or": filter_conditions}
```

#### 3.3.3 混合检索策略
1. **第一优先级**: 使用层级过滤进行精确检索
2. **第二优先级**: 如果结果数量不足，使用无过滤的向量检索作为补充
3. **结果融合**: 将两种结果进行去重和排序

## 4. 实施建议

### 4.1 短期方案
1. **完善实体映射表**: 建立完整的简写到全称映射关系
2. **优化层级结构**: 确保h1~h6字段与实际内容匹配
3. **实现混合检索**: 结合层级过滤和向量检索

### 4.2 长期方案
1. **智能实体识别**: 使用LLM识别用户输入中的实体
2. **动态层级匹配**: 根据实体类型自动选择合适的层级字段
3. **结果质量评估**: 建立检索结果质量评估机制

## 5. 结论

### 5.1 可行性结论
✅ **方案可行**: 分层检索方案在技术上是完全可行的，能够显著提高检索相关性

### 5.2 实施建议
1. **推荐实施**: 建议采用混合检索策略，结合层级过滤和向量检索
2. **优先级**: 优先完善实体映射表和层级结构
3. **迭代优化**: 根据实际使用效果持续优化检索策略

### 5.3 预期效果
- **相关性提升**: 预计能提高20-50%的检索相关性
- **精度提升**: 减少不相关结果的干扰
- **用户体验**: 提供更精准的答案

---

**总结**: 分层检索方案是一个有前景的技术方向，通过合理的实施和优化，能够有效解决当前检索精度不足的问题。 