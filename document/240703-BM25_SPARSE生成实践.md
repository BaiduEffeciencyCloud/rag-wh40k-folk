# 240703-BM25 SPARSE生成实践

## 一、背景

在RAG/检索系统中，BM25稀疏向量（SPARSE）作为高效的文本检索基础，广泛用于召回和排序。但在实际工程中，分词粒度不一致、专有名词被拆分、词典更新不及时等问题，常常导致召回效果不佳。

## 二、典型问题

- 专有名词（如"阿苏焉尼"）被拆分，召回不准。
- 词典（vocab）和分词口径不一致，影响sparse向量表达。
- 保护性词典（userdict）未自动生成或未被正确加载。
- 多文件/多批次处理时，userdict容易被覆盖或遗漏。

## 三、方案设计

1. **自动短语抽取**：基于频次+PMI，从原始语料中自动抽取高质量短语，动态生成保护性词典（userdict）。
2. **自动命名与刷新**：userdict命名为`{inputfile}_dict.txt`，每次处理新文件时自动生成/刷新，避免覆盖和遗漏。
3. **分词口径统一**：主流程和测评流程全部复用BM25Manager的分词方法，保证分词、词频、稀疏向量等完全一致。
4. **自动加载保护性词典**：BM25Manager初始化时自动加载对应userdict，分词时保护专有名词。
5. **自动化流程串联**：主流程和测评流程均先生成/刷新userdict，再初始化BM25Manager，保证流程健壮。

## 四、工程实现

- `DATAUPLOD/gen_userdict.py`：自动抽取短语，生成`{inputfile}_dict.txt`。
- `DATAUPLOD/bm25_manager.py`：支持userdict自动加载，分词方法统一。
- `evaltool/vocab_intrinsic_eval.py`：测评流程自动推断userdict路径，分词与主流程一致。
- 日志输出userdict加载路径和内容，便于调试。

## 五、自动化流程示例

```python
# 1. 生成/刷新保护性词典
ios.system(f"python3 DATAUPLOD/gen_userdict.py --f {input_file}")
userdict_path = f"{os.path.basename(input_file).split('.')[0]}_dict.txt"
# 2. 初始化BM25Manager，加载userdict
bm25 = BM25Manager(user_dict_path=userdict_path)
bm25.fit([open(input_file, 'r', encoding='utf-8').read()])
# ...后续流程
```

## 六、最佳实践

- 每次处理新文件/新批次时，**始终先生成/刷新userdict**，再用BM25Manager。
- userdict命名采用`{inputfile}_dict.txt`，避免多文件覆盖。
- 分词、词频、稀疏向量等全部用BM25Manager的分词方法，保证一致性。
- 日志中输出userdict加载路径和内容，便于排查。
- 支持手动指定userdict路径，兼容特殊需求。

## 七、常见问题与建议

- **userdict未生效**：检查路径、内容格式、加载时机。
- **专有名词仍被拆分**：确认userdict内容、分词方法是否统一。
- **多文件批量处理**：可循环生成各自userdict，或合并语料生成总userdict。
- **评测与主流程分词不一致**：务必统一分词方法和userdict加载逻辑。

## 八、总结

本次优化实现了BM25 SPARSE生成流程的自动化、工程化和高可用，极大提升了检索召回质量和系统健壮性。保护性词典自动生成与自动加载机制，保证了专有名词和高频短语的分词完整性，是RAG系统工程落地的关键经验。

## 九、全库统一词典的重要性

- 在BM25 SPARSE检索系统中，**所有文档必须共用一个全局词典（vocabulary）**，即所有chunk和所有query都用同一个词典编码稀疏向量。
- 如果每个文档单独生成词典，则不同文档的sparse向量"坐标系"不同，跨文档检索会严重失效，召回率和准确率都会大幅下降。
- 业界标准做法是：
  1. 先将所有文档分词、统计，生成全局高频词表（剪枝后）。
  2. 用这个词典对所有chunk和所有query编码sparse向量。
  3. 保护性词典（userdict）也建议合并所有文档后统一生成。
- **结论：全库统一词典是稀疏向量检索的基本前提，只有这样才能保证跨文档、跨批次的检索效果和可维护性。** 