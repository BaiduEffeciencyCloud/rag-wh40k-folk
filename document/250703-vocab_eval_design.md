# 设计文档：run_vocab_eval评估流程

## 1. 设计目标

- **唯一数据源**：评估流程只分析主流程（gen_userdict.py）产出的词典文件，保证评估与实际检索/上线环境100%一致。
- **零冗余实现**：所有分词、过滤、短语保护等逻辑只在gen_userdict.py维护，评估流程绝不拷贝粘贴或"自由发挥"。
- **工程健壮性**：评估流程对空数据、极端数据、异常数据、正常数据均有兜底，产物归档清晰。

---

## 2. 评估流程

### 步骤1：生成词典（可选/推荐）

- 通过**直接调用gen_userdict.py的主方法**（如import或subprocess），用指定参数（如--input-folder、--output-dir、--filter等）生成词典。
- 评估流程**不再实现任何分词、过滤、短语抽取等逻辑**，一切以gen_userdict.py产物为准。

### 步骤2：查找最新词典

- 在指定的dict目录下，自动查找最新的`bm25_vocab_*.json`和`all_docs_dict_*.txt`。
- 只分析这两个文件，**不再重新fit、分词或生成新词表**。

### 步骤3：评估与报告

- 直接用`json.load`加载bm25_vocab_*.json，统计token长度分布、类型分布、OOV率、覆盖率、IDF分布等。
- 评估产物（图片、报告）统一输出到evaltool/日期/目录，带时间戳。
- 所有统计、可视化、报告输出前都加空数据兜底，保证健壮性。

---

## 3. 代码结构建议

- `run_vocab_eval`只负责加载现有词典、做统计和可视化，不再有任何分词、过滤、BM25Manager相关实现。
- 词典生成、分词、过滤等全部通过gen_userdict.py维护和调用。

---

## 4. 变更确认机制

- **每次改动run_vocab_eval或评估流程时，必须先阅读本设计文档。**
- **如识别到用户有新意图（如需扩展评估内容、调整产物结构等），必须主动与用户确认，绝不私自"优化"或"创新"。**
- **如需扩展主流程逻辑，先在gen_userdict.py实现，再在评估流程复用。**

---

## 5. 工程自查清单

- [ ] 评估流程是否只分析主流程产物？
- [ ] 是否有任何分词、过滤、BM25Manager等冗余实现？（如有，立即删除）
- [ ] 是否所有统计、可视化、报告输出前都加了空数据兜底？
- [ ] 产物归档、命名、内容是否清晰、可追溯？
- [ ] 变更前是否已与用户确认新意图？

---

**后续如有任何改动，我会严格对照本设计文档执行，并主动与你确认！**
如需补充细节或有新需求，请随时补充到本设计文档。 