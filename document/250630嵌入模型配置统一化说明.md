# 嵌入模型配置统一化说明

## 修改背景

在排查向量检索召回问题时，发现系统中存在嵌入模型使用不一致的问题：
- 数据上传时使用：`text-embedding-ada-002`
- 向量搜索时使用：`text-embedding-3-small`

这导致了严重的召回问题，相似度分数从0.8+降到0.01-0.02。

## 解决方案

将所有涉及嵌入模型的地方统一使用环境变量配置，确保整个pipeline使用相同的嵌入模型。

## 修改内容

### 1. 配置文件修改 (config.py)

```python
# 修改前
EMBADDING_MODEL = "text-embedding-3-small"

# 修改后
EMBADDING_MODEL = os.getenv("EMBEDDING_MODEL", "text-embedding-ada-002")
```

### 2. 向量搜索模块修改 (vector_search.py)

```python
# 修改前
def get_embedding(self, text):
    response = self.client.embeddings.create(
        model="text-embedding-ada-002",  # 硬编码
        input=text
    )
    return response.data[0].embedding

# 修改后
def get_embedding(self, text):
    response = self.client.embeddings.create(
        model=EMBADDING_MODEL,  # 使用统一配置
        input=text
    )
    return response.data[0].embedding
```

### 3. 数据上传模块修改 (DATAUPLOD/vector_upload.py)

```python
# 修改前
OPENAI_EMBED_MODEL = os.getenv("EMBEDDING_MODEL", "text-embedding-ada-002")

# 修改后
import sys
sys.path.append('..')
from config import EMBADDING_MODEL
OPENAI_EMBED_MODEL = EMBADDING_MODEL
```

### 4. 数据上传脚本修改 (DATAUPLOD/upsert.py)

```python
# 修改前
embeddings = OpenAIEmbeddings(openai_api_key=OPENAI_API_KEY)

# 修改后
import sys
sys.path.append('..')
from config import EMBADDING_MODEL

embeddings = OpenAIEmbeddings(
    openai_api_key=OPENAI_API_KEY,
    model=EMBADDING_MODEL
)
```

## 环境变量配置

在`.env`文件中添加或修改：

```bash
# 嵌入模型配置
EMBEDDING_MODEL=text-embedding-ada-002
```

## 统一配置的好处

1. **一致性保证**：整个pipeline使用相同的嵌入模型
2. **易于管理**：通过环境变量统一管理模型版本
3. **避免错误**：防止因模型不匹配导致的召回问题
4. **便于升级**：只需修改环境变量即可升级模型版本

## 验证结果

修改后的测试结果：
- 相似度分数：0.83-0.85（显著提升）
- 召回内容：高度相关
- 成功找到丑角剧团相关信息

## 最佳实践

1. **环境变量优先**：所有模型配置都通过环境变量管理
2. **默认值设置**：为环境变量设置合理的默认值
3. **配置集中化**：在config.py中统一管理所有配置
4. **导入路径处理**：正确处理跨目录的模块导入

## 注意事项

1. **路径导入**：DATAUPLOD目录下的文件需要添加`sys.path.append('..')`来导入上级目录的config
2. **环境变量检查**：在应用启动时检查必要的环境变量是否存在
3. **向后兼容**：保持与现有代码的兼容性

---

**修改时间**：2025-06-29  
**修改范围**：嵌入模型配置统一化  
**影响模块**：vector_search.py, DATAUPLOD/vector_upload.py, DATAUPLOD/upsert.py, config.py  
**测试状态**：已验证 ✅ 