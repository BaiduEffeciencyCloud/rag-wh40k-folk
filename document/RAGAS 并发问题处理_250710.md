# RAGAS 并发问题处理（经验总结）

> 生成时间：2025-07-10

---

## RAGAS评估nan问题排查经验总结

### 1. 现象发现

- RAGAS评估报告中多个关键指标（如context_relevance、context_recall、faithfulness）全部为nan，只有部分指标有分数。
- 检查评估用的query、answer、contexts等数据，内容丰富且无空值，理论上不应为nan。

### 2. 初步分析

- 首先怀疑是数据本身问题（如contexts为空、answer为空、字段类型不符等），但通过分析dataset_details.json确认数据结构和内容均正常。
- 排除了数据格式、字段名、内容为空等常见问题。

### 3. 结合RAGAS评估机制进一步推理

- RAGAS的部分指标（如context_relevance、faithfulness等）依赖于LLM API调用。
- 如果评估时API调用失败、被限流或异常，RAGAS会跳过该样本，导致相关指标为nan。

### 4. 结合终端日志定位根因

- 命令行输出报错：

  ``` json

  Error code: 429 - {'error': {'message': 'Rate limit reached for gpt-4o-mini ...'}}
  Skipping a sample by assigning it nan score.

  ```

- 说明评估过程中触发了OpenAI的API速率限制（Rate Limit），RAGAS自动跳过被限流样本，导致相关指标为nan。

### 5. 验证与确认

- 查阅RAGAS官方文档，确认`evaluate`方法支持`concurrency`参数，用于控制并发请求数，官方建议遇到429限流时调低该参数。
- RAGAS本身没有batch_size参数，速率控制核心就是concurrency。

### 6. 版本兼容性问题发现

- **RAGAS 0.2.15版本不支持`concurrency`参数**，会报错`TypeError: evaluate() got an unexpected keyword argument 'concurrency'`
- **正确的方式是使用`run_config`参数**，通过`RunConfig(max_workers=1, max_retries=3, timeout=60)`来控制并发
- `max_workers=1`相当于串行执行，`max_retries=3`提供重试机制，`timeout=60`设置超时时间

### 7. 解决方案与最佳实践

- **RAGAS 0.2.15版本**：使用`run_config=RunConfig(max_workers=1, max_retries=3, timeout=60)`控制并发
- **RAGAS更新版本**：可能支持`concurrency`参数，但需要验证版本兼容性
- **通用建议**：设置`max_workers=1`（串行执行）可最大程度避免API限流
- **重试机制**：设置`max_retries=3`提供自动重试，`timeout=60`避免长时间等待
- 可在外层加sleep或自动重试机制，进一步提升健壮性。

---

## 经验教训

1. 遇到评估nan，优先排查API调用异常和限流问题，而非只盯数据本身。
2. 关注终端日志和报错信息，429/Rate Limit是最直接的线索。
3. 熟悉评估工具的速率控制参数（如concurrency），并查阅官方文档获取权威建议。
4. 数据没问题时，优先考虑外部依赖（如LLM API）的调用配额和速率限制。
5. 将速率控制参数（如concurrency）作为可配置项，便于灵活调整和自动化处理。

