# 250702-COT分析法（RAG检索召回问题定位全流程）

## 适用场景
适用于RAG系统中检索/召回不全、答案缺失等问题的系统性定位与归因。

---

## 分析流程

### 1. 明确query和标准答案
- **输入**：用户提供query和标准答案（ground truth）。
- **目的**：明确检索目标和评价标准。

---

### 2. 用cot_search召回最终答案，并与标准答案比对
- **操作**：运行cot_search，获取系统最终返回的答案。
- **比对**：将cot_search结果与标准答案逐条对比，找出缺失/错误/不准确的点。
- **输出**：差距分析（哪些关键信息未被召回？）

---

### 3. 用query_cot查看子查询，确认子查询逻辑无误
- **操作**：运行query_cot，输出所有生成的子查询（思维链变体）。
- **检查**：人工或自动检查子查询是否覆盖了所有标准答案涉及的知识点/能力/技能。
- **输出**：子查询设计是否合理，是否有遗漏。

---

### 4. 用vector_search对每个子查询召回结果，检查top_k是否包含关键信息
- **操作**：对每个子查询分别用vector_search召回top_k结果。
- **分析**：检查top_k结果中是否包含标准答案中的关键信息chunk。
- **输出**：哪些子查询能召回关键信息，哪些不能。

---

### 5. 检查本地chunk，确认关键信息是否存在，抓取对应metadata
- **操作**：在本地切片文件（如semantic_chunks_xxx.json）中全文搜索关键信息（如"死亡之舞"）。
- **输出**：确认本地切片中有无该内容，并抓取其完整metadata。

---

### 6. 用pinecone_manager的query接口，通过filter定位数据库里对应数据，确保数据已上传
- **操作**：用metadata filter（如h3/section_heading等）通过pinecone_manager.py的query接口查找线上数据库。
- **输出**：确认线上数据库中有无该chunk，metadata是否一致。

---

### 7. 最终结论：定位问题归因
- **如果本地和线上都有数据，但vector_search召回不到**：属于检索/embedding/相关性问题。
- **如果本地有但线上没有**：属于上传/入库流程问题。
- **如果本地都没有**：属于切片/预处理问题。
- **输出**：问题归因和下一步优化建议。

---

## 总结

该COT分析法实现了"从用户query到最终召回结果"的全链路闭环排查，能精准定位RAG系统中召回失败的根本原因。每一步都可自动化实现，便于批量测试和持续优化。

如需自动化脚本模板、每步代码示例，或希望将此流程写成一键分析工具，可进一步扩展。 