# 250705 Sparseå‘é‡åˆ†æå·¥å…·è®¾è®¡æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 ç›®æ ‡
åˆ›å»ºä¸€ä¸ªè¯„ä¼°å·¥å…·ï¼Œç”¨äºåˆ†æchunkçš„sparseå‘é‡ç”Ÿæˆæƒ…å†µï¼Œè¯†åˆ«sparseå€¼ä¸ºç©ºçš„chunkï¼Œå¸®åŠ©ä¼˜åŒ–BM25å‚æ•°é…ç½®ã€‚

### 1.2 åŠŸèƒ½éœ€æ±‚
- æ”¯æŒåŠ¨æ€è°ƒæ•´BM25å‚æ•°ï¼ˆmin_freq, max_vocab_sizeï¼‰
- è‡ªåŠ¨è°ƒç”¨gen_userdict.pyé‡æ–°ç”Ÿæˆè¯å…¸
- æ‰¹é‡åˆ†æchunkæ–‡ä»¶çš„sparseå‘é‡ç”Ÿæˆ
- è¯†åˆ«å¹¶æ”¶é›†sparseå€¼ä¸ºç©ºçš„chunk
- ç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘ŠJSON

### 1.3 ä½¿ç”¨åœºæ™¯
- è°ƒè¯•"Sparse vector must contain at least one value"é”™è¯¯
- ä¼˜åŒ–BM25å‚æ•°é…ç½®
- åˆ†æchunkè´¨é‡
- è¯„ä¼°è¯å…¸è¦†ç›–åº¦

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ–‡ä»¶ç»“æ„
```
evaltool/
â”œâ”€â”€ sparse_analyzer.py          # ä¸»åˆ†æç±»
â”œâ”€â”€ config_manager.py           # å‚æ•°é…ç½®ç®¡ç†
â”œâ”€â”€ chunk_processor.py          # chunkå¤„ç†é€»è¾‘
â”œâ”€â”€ report_generator.py         # æŠ¥å‘Šç”Ÿæˆå™¨
â””â”€â”€ main.py                     # å‘½ä»¤è¡Œå…¥å£
```

### 2.2 æ ¸å¿ƒç±»è®¾è®¡

#### 2.2.1 SparseAnalyzerç±»
```python
class SparseAnalyzer:
    def __init__(self, config: SparseAnalyzerConfig):
        self.config = config
        self.bm25_manager = None
        self.results = []
    
    def analyze_chunks(self, chunk_file_path: str) -> AnalysisResult:
        """åˆ†æchunkæ–‡ä»¶çš„sparseå‘é‡ç”Ÿæˆæƒ…å†µ"""
        
    def adjust_bm25_params(self, min_freq: int, max_vocab_size: int):
        """è°ƒæ•´BM25å‚æ•°å¹¶é‡æ–°ç”Ÿæˆè¯å…¸"""
        
    def generate_report(self) -> dict:
        """ç”Ÿæˆåˆ†ææŠ¥å‘Š"""
```

#### 2.2.2 SparseAnalyzerConfigç±»
```python
class SparseAnalyzerConfig:
    def __init__(self):
        self.min_freq = 5
        self.max_vocab_size = 10000
        self.input_dir = "data"  # è¯å…¸ç”Ÿæˆçš„è¾“å…¥ç›®å½•
        self.output_dir = "dict"  # è¯å…¸è¾“å‡ºç›®å½•
        self.gen_userdict_path = "dataupload/gen_userdict.py"
        self.report_output_path = "evaltool/sparse_analysis_report.json"
```

## 3. è¯¦ç»†è®¾è®¡

### 3.1 å‚æ•°è°ƒæ•´æµç¨‹
1. **æ¥æ”¶æ–°å‚æ•°**ï¼šmin_freq, max_vocab_size
2. **ä¸´æ—¶è®¾ç½®ç¯å¢ƒå˜é‡**ï¼šé€šè¿‡`os.environ`ä¸´æ—¶è¦†å†™`BM25_MIN_FREQ`, `BM25_MAX_VOCAB_SIZE`ï¼ˆä¸ä¿®æ”¹config.pyé»˜è®¤å€¼ï¼‰
3. **è°ƒç”¨gen_userdict.py**ï¼šé‡æ–°ç”Ÿæˆè¯å…¸
4. **éªŒè¯è¯å…¸ç”Ÿæˆ**ï¼šæ£€æŸ¥æ–°è¯å…¸æ–‡ä»¶æ˜¯å¦å­˜åœ¨
5. **æ¢å¤ç¯å¢ƒå˜é‡**ï¼šåˆ†æå®Œæˆåæ¢å¤åŸå§‹ç¯å¢ƒå˜é‡è®¾ç½®

### 3.2 Chunkåˆ†ææµç¨‹
1. **åŠ è½½chunkæ–‡ä»¶**ï¼šè¯»å–JSONæ ¼å¼çš„chunkæ•°æ®ï¼ˆdata_vector_v3.pyç”Ÿæˆçš„æ ¼å¼ï¼‰
2. **åˆå§‹åŒ–BM25Manager**ï¼šä½¿ç”¨æ–°ç”Ÿæˆçš„è¯å…¸
3. **é€ä¸ªåˆ†æchunk**ï¼š
   - æå–chunkæ–‡æœ¬ï¼ˆä»`text`å­—æ®µï¼‰
   - å¯é€‰ï¼šç»“åˆæ ‡é¢˜ä¿¡æ¯ï¼ˆ`section_heading`, `h1`-`h6`ï¼‰å¢å¼ºè¯æ±‡è¦†ç›–
   - è°ƒç”¨BM25Manager.get_sparse_vector()
   - è®°å½•sparseå‘é‡ç»“æœ
   - è¯†åˆ«ç©ºsparseå‘é‡çš„chunk
4. **ç»Ÿè®¡ç»“æœ**ï¼šè®¡ç®—å„ç§ç»Ÿè®¡æŒ‡æ ‡

### 3.3 Chunkæ ¼å¼è¯´æ˜
æ ¹æ®`data_vector_v3.py`çš„`_create_chunk_metadata`æ–¹æ³•ï¼Œchunkç»“æ„ä¸ºï¼š
```python
{
    'text': str,                    # ä¸»è¦æ–‡æœ¬å†…å®¹ï¼ˆç”¨äºsparseå‘é‡ç”Ÿæˆï¼‰
    'section_heading': str,         # ç« èŠ‚æ ‡é¢˜
    'chunk_type': str,              # åˆ‡ç‰‡ç±»å‹
    'content_type': str,            # å†…å®¹ç±»å‹
    'faction': str,                 # æ´¾ç³»
    'h1': str, 'h2': str, ..., 'h6': str,  # æ ‡é¢˜å±‚çº§
    # å¯èƒ½è¿˜æœ‰å…¶ä»–extra_metadataå­—æ®µ
}
```

### 3.4 æŠ¥å‘Šç”Ÿæˆæ ¼å¼
```json
{
  "analysis_config": {
    "min_freq": 5,
    "max_vocab_size": 10000,
    "analysis_time": "2025-07-05T18:00:00",
    "chunk_file_path": "dataupload/chunks/xxx.json"
  },
  "bm25_stats": {
    "vocabulary_size": 462,
    "model_path": "models/bm25_model.pkl",
    "vocab_path": "dict/bm25_vocab_xxx.json",
    "userdict_path": "dict/all_docs_dict_xxx.txt"
  },
  "chunk_analysis": {
    "total_chunks": 150,
    "chunks_with_sparse": 120,
    "chunks_without_sparse": 30,
    "sparse_coverage_rate": 0.8
  },
  "empty_sparse_chunks": [
    {
      "chunk_id": "file1-15",
      "text": "åŸå§‹æ–‡æœ¬å†…å®¹",
      "text_length": 45,
      "tokens": ["åˆ†è¯", "ç»“æœ"],
      "reason": "æ‰€æœ‰è¯æ±‡éƒ½ä¸åœ¨BM25è¯æ±‡è¡¨ä¸­"
    }
  ],
  "sparse_vector_stats": {
    "avg_indices_count": 3.2,
    "max_indices_count": 12,
    "min_indices_count": 0,
    "avg_weight": 1.85,
    "weight_distribution": {
      "0-1": 25,
      "1-2": 45,
      "2-3": 30,
      "3+": 20
    }
  }
}
```

## 4. å®ç°ç»†èŠ‚

### 4.1 ç¯å¢ƒå˜é‡ç®¡ç†
```python
def set_bm25_env_vars(min_freq: int, max_vocab_size: int):
    """ä¸´æ—¶è®¾ç½®BM25ç¯å¢ƒå˜é‡ï¼ˆä¸ä¿®æ”¹config.pyé»˜è®¤å€¼ï¼‰"""
    # ä¿å­˜åŸå§‹å€¼
    original_min_freq = os.environ.get('BM25_MIN_FREQ')
    original_max_vocab_size = os.environ.get('BM25_MAX_VOCAB_SIZE')
    
    # ä¸´æ—¶è®¾ç½®æ–°å€¼
    os.environ['BM25_MIN_FREQ'] = str(min_freq)
    os.environ['BM25_MAX_VOCAB_SIZE'] = str(max_vocab_size)
    
    return original_min_freq, original_max_vocab_size

def restore_bm25_env_vars(original_min_freq: str, original_max_vocab_size: str):
    """æ¢å¤åŸå§‹ç¯å¢ƒå˜é‡è®¾ç½®"""
    if original_min_freq is not None:
        os.environ['BM25_MIN_FREQ'] = original_min_freq
    else:
        os.environ.pop('BM25_MIN_FREQ', None)
    
    if original_max_vocab_size is not None:
        os.environ['BM25_MAX_VOCAB_SIZE'] = original_max_vocab_size
    else:
        os.environ.pop('BM25_MAX_VOCAB_SIZE', None)
```

### 4.2 è¯å…¸ç”Ÿæˆè°ƒç”¨
```python
def regenerate_userdict(self):
    cmd = f"python3 {self.config.gen_userdict_path} --input-dir {self.config.input_dir} --output-dir {self.config.output_dir} --filter"
    subprocess.run(cmd, shell=True, check=True)
```

### 4.3 Chunkæ–‡æœ¬æå–
```python
def extract_chunk_text(self, chunk: dict, include_headers: bool = True) -> str:
    """ä»chunkä¸­æå–ç”¨äºsparseå‘é‡ç”Ÿæˆçš„æ–‡æœ¬"""
    text = chunk.get('text', '')
    
    if include_headers:
        # å¯é€‰ï¼šæ·»åŠ æ ‡é¢˜ä¿¡æ¯å¢å¼ºè¯æ±‡è¦†ç›–
        section_heading = chunk.get('section_heading', '')
        headers = []
        for i in range(1, 7):
            header = chunk.get(f'h{i}', '')
            if header:
                headers.append(header)
        
        if headers:
            text = f"{' '.join(headers)} {text}"
    
    return text
```

### 4.4 ç©ºsparseå‘é‡è¯†åˆ«
```python
def is_empty_sparse_vector(self, sparse_vector: dict) -> bool:
    """åˆ¤æ–­sparseå‘é‡æ˜¯å¦ä¸ºç©º"""
    if not sparse_vector:
        return True
    indices = sparse_vector.get('indices', [])
    return len(indices) == 0
```

## 5. ä½¿ç”¨ç¤ºä¾‹

### 5.1 å‘½ä»¤è¡Œä½¿ç”¨
```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°åˆ†æ
python3 evaltool/main.py --chunk-file dataupload/chunks/xxx.json

# è°ƒæ•´å‚æ•°ååˆ†æ
python3 evaltool/main.py --chunk-file dataupload/chunks/xxx.json --min-freq 2 --max-vocab-size 5000

# æŒ‡å®šè¾“å‡ºæŠ¥å‘Šè·¯å¾„
python3 evaltool/main.py --chunk-file dataupload/chunks/xxx.json --output evaltool/custom_report.json
```

### 5.2 ç¼–ç¨‹æ¥å£ä½¿ç”¨
```python
from evaltool.sparse_analyzer import SparseAnalyzer, SparseAnalyzerConfig

# åˆ›å»ºé…ç½®
config = SparseAnalyzerConfig()
config.min_freq = 2
config.max_vocab_size = 5000

# åˆ›å»ºåˆ†æå™¨
analyzer = SparseAnalyzer(config)

# åˆ†æchunkæ–‡ä»¶
result = analyzer.analyze_chunks("dataupload/chunks/xxx.json")

# ç”ŸæˆæŠ¥å‘Š
report = analyzer.generate_report()
print(f"ç©ºsparseå‘é‡çš„chunkæ•°é‡: {len(report['empty_sparse_chunks'])}")
```

## 6. è¾“å‡ºåˆ†æ

### 6.1 å…³é”®æŒ‡æ ‡
- **sparseè¦†ç›–ç‡**ï¼šæœ‰sparseå‘é‡çš„chunkæ¯”ä¾‹
- **å¹³å‡è¯æ±‡æ•°**ï¼šæ¯ä¸ªchunkçš„å¹³å‡sparseå‘é‡ç»´åº¦
- **æƒé‡åˆ†å¸ƒ**ï¼šsparseå‘é‡æƒé‡çš„åˆ†å¸ƒæƒ…å†µ
- **é—®é¢˜chunkåˆ†æ**ï¼šç©ºsparseå‘é‡çš„chunkç‰¹å¾

### 6.2 ä¼˜åŒ–å»ºè®®
- å¦‚æœsparseè¦†ç›–ç‡ä½ï¼Œå»ºè®®é™ä½min_freq
- å¦‚æœè¯æ±‡æ•°è¿‡å°‘ï¼Œå»ºè®®å¢åŠ max_vocab_size
- åˆ†æç©ºsparseå‘é‡çš„chunkå†…å®¹ï¼Œä¼˜åŒ–åˆ†è¯è§„åˆ™

## 7. æ‰©å±•åŠŸèƒ½

### 7.1 æ‰¹é‡å‚æ•°æµ‹è¯•
æ”¯æŒå¤šç»„å‚æ•°é…ç½®çš„æ‰¹é‡æµ‹è¯•ï¼Œæ‰¾å‡ºæœ€ä¼˜å‚æ•°ç»„åˆã€‚

### 7.2 å¯è§†åŒ–æŠ¥å‘Š
ç”Ÿæˆå›¾è¡¨å±•ç¤ºsparseå‘é‡åˆ†å¸ƒæƒ…å†µã€‚

### 7.3 è‡ªåŠ¨ä¼˜åŒ–å»ºè®®
åŸºäºåˆ†æç»“æœè‡ªåŠ¨æ¨èå‚æ•°è°ƒæ•´æ–¹æ¡ˆã€‚

## 8. æ³¨æ„äº‹é¡¹

### 8.1 æ€§èƒ½è€ƒè™‘
- å¤§é‡chunkåˆ†ææ—¶è€ƒè™‘åˆ†æ‰¹å¤„ç†
- è¯å…¸é‡æ–°ç”Ÿæˆå¯èƒ½è€—æ—¶è¾ƒé•¿

### 8.2 é”™è¯¯å¤„ç†
- è¯å…¸ç”Ÿæˆå¤±è´¥çš„å¤„ç†
- chunkæ–‡ä»¶æ ¼å¼é”™è¯¯çš„å¤„ç†
- BM25æ¨¡å‹åŠ è½½å¤±è´¥çš„å¤„ç†

### 8.3 å…¼å®¹æ€§
- æ”¯æŒä¸åŒæ ¼å¼çš„chunkæ–‡ä»¶
- å…¼å®¹ä¸åŒç‰ˆæœ¬çš„gen_userdict.py

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š250705** 

# Sparseå‘é‡åˆ†æå·¥å…·ä½¿ç”¨è¯´æ˜

**ç”Ÿæˆæ—¶é—´**: 2024-12-01  
**å·¥å…·ç‰ˆæœ¬**: 1.0.0

## æ¦‚è¿°

Sparseå‘é‡åˆ†æå·¥å…·ç”¨äºåˆ†æchunkæ–‡ä»¶ä¸­sparseå‘é‡ç”Ÿæˆæƒ…å†µï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´BM25å‚æ•°ï¼Œè¯†åˆ«ç©ºsparseå‘é‡å¹¶ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ” **åŠ¨æ€å‚æ•°è°ƒæ•´**: æ”¯æŒä¸´æ—¶è°ƒæ•´BM25çš„min_freqå’Œmax_vocab_sizeå‚æ•°
- ğŸ“Š **è¯¦ç»†åˆ†æ**: åˆ†æchunkæ–‡æœ¬ç‰¹å¾ã€sparseå‘é‡ç»Ÿè®¡ã€è¯æ±‡è¡¨è¦†ç›–ç‡
- ğŸ¯ **ç©ºå‘é‡è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«å¹¶åˆ†æç©ºsparseå‘é‡çš„åŸå› 
- ğŸ“ˆ **æ™ºèƒ½å»ºè®®**: åŸºäºåˆ†æç»“æœç”Ÿæˆæ”¹è¿›å»ºè®®
- ğŸ“ **å®Œæ•´æŠ¥å‘Š**: ç”ŸæˆJSONæ ¼å¼çš„è¯¦ç»†åˆ†ææŠ¥å‘Š

## å®‰è£…ä¾èµ–

ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹PythonåŒ…ï¼š
```bash
pip3 install jieba
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°åˆ†æ
python3 evaltool/analyze_sparse.py data/chunks.json

# è°ƒæ•´BM25å‚æ•°
python3 evaltool/analyze_sparse.py data/chunks.json --min_freq 3 --max_vocab 15000

# ä½¿ç”¨ç°æœ‰è¯å…¸ï¼ˆä¸é‡æ–°ç”Ÿæˆï¼‰
python3 evaltool/analyze_sparse.py data/chunks.json --no_gen_dict

# æŒ‡å®šè¾“å‡ºæŠ¥å‘Šè·¯å¾„
python3 evaltool/analyze_sparse.py data/chunks.json --output report.json
```

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | ç®€å†™ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| `chunk_file` | - | æ–‡ä»¶è·¯å¾„ | å¿…éœ€ | chunkæ–‡ä»¶è·¯å¾„ |
| `--min_freq` | `-mf` | æ•´æ•° | 5 | æœ€å°è¯é¢‘ |
| `--max_vocab` | `-mv` | æ•´æ•° | 10000 | æœ€å¤§è¯æ±‡è¡¨å¤§å° |
| `--no_gen_dict` | `-ngd` | æ ‡å¿— | False | ä¸é‡æ–°ç”Ÿæˆè¯å…¸ |
| `--output` | `-o` | æ–‡ä»¶è·¯å¾„ | evaltool/sparse_analysis_report.json | è¾“å‡ºæŠ¥å‘Šè·¯å¾„ |
| `--no_headers` | `-nh` | æ ‡å¿— | False | ä¸åŒ…å«æ ‡é¢˜ä¿¡æ¯ |
| `--verbose` | `-v` | æ ‡å¿— | False | è¯¦ç»†è¾“å‡º |

## è¾“å‡ºæŠ¥å‘Šæ ¼å¼

åˆ†æå®Œæˆåä¼šç”ŸæˆJSONæ ¼å¼çš„æŠ¥å‘Šï¼ŒåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

### 1. æŠ¥å‘Šä¿¡æ¯ (report_info)
```json
{
  "timestamp": "20241201_143022",
  "generated_at": "2024-12-01T14:30:22",
  "tool_version": "1.0.0"
}
```

### 2. é…ç½®ä¿¡æ¯ (configuration)
```json
{
  "min_freq": 5,
  "max_vocab_size": 10000,
  "include_headers": true,
  "dict_file": "dict/userdict_20241201_143022.json"
}
```

### 3. æ‘˜è¦ä¿¡æ¯ (summary)
```json
{
  "total_chunks": 1000,
  "empty_sparse_count": 50,
  "empty_sparse_rate": 0.05,
  "vocabulary_size": 5000,
  "vocab_coverage_rate": 0.85
}
```

### 4. è¯¦ç»†åˆ†æ (detailed_analysis)
- **sparse_vector_stats**: sparseå‘é‡ç»Ÿè®¡ä¿¡æ¯
- **vocabulary_stats**: è¯æ±‡è¡¨ç»Ÿè®¡ä¿¡æ¯
- **vocabulary_coverage**: è¯æ±‡è¡¨è¦†ç›–ç‡åˆ†æ
- **empty_sparse_chunks**: ç©ºsparseå‘é‡çš„chunkåˆ—è¡¨

### 5. æ”¹è¿›å»ºè®® (recommendations)
```json
[
  "ç©ºsparseå‘é‡æ¯”ä¾‹è¾ƒé«˜(15.00%)ï¼Œå»ºè®®è°ƒæ•´BM25å‚æ•°",
  "è¯æ±‡è¦†ç›–ç‡è¾ƒä½(45.00%)ï¼Œå»ºè®®é™ä½min_freqæˆ–å¢åŠ max_vocab_size"
]
```

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€åˆ†æ
```bash
python3 evaltool/analyze_sparse.py data/chunks.json
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
å¼€å§‹åˆ†æchunkæ–‡ä»¶: data/chunks.json
é…ç½®: min_freq=5, max_vocab_size=10000
åŒ…å«æ ‡é¢˜: True
ç”Ÿæˆæ–°è¯å…¸: True

============================================================
SPARSEå‘é‡åˆ†ææŠ¥å‘Šæ‘˜è¦
============================================================
æ€»chunkæ•°é‡: 1000
ç©ºsparseå‘é‡æ•°é‡: 50
ç©ºsparseå‘é‡æ¯”ä¾‹: 5.00%
è¯æ±‡è¡¨å¤§å°: 5000
è¯æ±‡è¦†ç›–ç‡: 85.00%

æ”¹è¿›å»ºè®®:
  1. å½“å‰é…ç½®è¡¨ç°è‰¯å¥½ï¼Œæ— éœ€è°ƒæ•´
============================================================

è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°: evaltool/sparse_analysis_report.json
```

### ç¤ºä¾‹2: å‚æ•°è°ƒä¼˜
```bash
python3 evaltool/analyze_sparse.py data/chunks.json --min_freq 3 --max_vocab 15000 --verbose
```

### ç¤ºä¾‹3: ä½¿ç”¨ç°æœ‰è¯å…¸
```bash
python3 evaltool/analyze_sparse.py data/chunks.json --no_gen_dict --output custom_report.json
```

## åˆ†ææŒ‡æ ‡è¯´æ˜

### ç©ºsparseå‘é‡æ¯”ä¾‹
- **ç›®æ ‡**: < 10%
- **å«ä¹‰**: æ— æ³•ç”Ÿæˆsparseå‘é‡çš„chunkæ¯”ä¾‹
- **æ”¹è¿›**: é™ä½min_freqæˆ–å¢åŠ max_vocab_size

### è¯æ±‡è¡¨è¦†ç›–ç‡
- **ç›®æ ‡**: > 70%
- **å«ä¹‰**: chunkä¸­è¯æ±‡åœ¨BM25è¯æ±‡è¡¨ä¸­çš„è¦†ç›–ç‡
- **æ”¹è¿›**: é™ä½min_freqæˆ–å¢åŠ max_vocab_size

### è¯æ±‡è¡¨å¤§å°
- **æ¨èèŒƒå›´**: 1000-50000
- **è¿‡å°**: è¯æ±‡è¦†ç›–ç‡ä½ï¼Œç©ºå‘é‡å¤š
- **è¿‡å¤§**: è®¡ç®—å¼€é”€å¤§ï¼Œå¯èƒ½è¿‡æ‹Ÿåˆ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ‰¾ä¸åˆ°chunkæ–‡ä»¶**
   ```
   é”™è¯¯: chunkæ–‡ä»¶ä¸å­˜åœ¨: data/chunks.json
   ```
   **è§£å†³**: æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®

2. **è¯å…¸ç”Ÿæˆå¤±è´¥**
   ```
   ç”Ÿæˆè¯å…¸å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
   ```
   **è§£å†³**: æ£€æŸ¥dataç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿçš„è¾“å…¥æ–‡ä»¶

3. **æ¨¡å—å¯¼å…¥é”™è¯¯**
   ```
   æ— æ³•å¯¼å…¥BM25Manageræ¨¡å—
   ```
   **è§£å†³**: ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼Œæˆ–è®¾ç½®PYTHONPATH

### è°ƒè¯•æ¨¡å¼

ä½¿ç”¨`--verbose`å‚æ•°è·å–è¯¦ç»†æ—¥å¿—ï¼š
```bash
python3 evaltool/analyze_sparse.py data/chunks.json --verbose
```

## æŠ€æœ¯æ¶æ„

å·¥å…·é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

- **SparseAnalyzerConfig**: é…ç½®ç®¡ç†
- **ChunkProcessor**: chunkå¤„ç†å’Œæ–‡æœ¬åˆ†æ
- **BM25Manager**: BM25è¯å…¸ç”Ÿæˆå’Œå‘é‡è®¡ç®—
- **SparseAnalyzer**: ä¸»åˆ†æå™¨ï¼Œæ•´åˆæ‰€æœ‰åŠŸèƒ½

## ç‰ˆæœ¬å†å²

- **v1.0.0** (2024-12-01): åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºç¡€sparseå‘é‡åˆ†æåŠŸèƒ½ 

# Sparseå‘é‡è¯„ä¼°å·¥å…·å¼€å‘æ€»ç»“

**ç”Ÿæˆæ—¶é—´**: 2025-07-05  
**å¼€å‘èƒŒæ™¯**: è§£å†³BM25 sparseå‘é‡ç”Ÿæˆè´¨é‡è¯„ä¼°é—®é¢˜ï¼Œæ”¯æŒåŠ¨æ€å‚æ•°è°ƒä¼˜

## 1. é¡¹ç›®èƒŒæ™¯ä¸é—®é¢˜

### 1.1 åŸå§‹é—®é¢˜
- ä¸Šä¼ æ–‡æ¡£æ—¶PineconeæŠ¥é”™ï¼š"Sparse vector must contain at least one value"
- æ€€ç–‘BM25å‚æ•°é…ç½®è¿‡ä¸¥å¯¼è‡´è¯å…¸è¿‡å°ï¼Œsparseå‘é‡ç”Ÿæˆå¤±è´¥
- éœ€è¦å·¥å…·è¯Šæ–­sparseå‘é‡ç”Ÿæˆæƒ…å†µï¼Œæ”¯æŒå‚æ•°è°ƒä¼˜

### 1.2 æŠ€æœ¯æŒ‘æˆ˜
- éœ€è¦åŠ¨æ€è°ƒæ•´BM25å‚æ•°ï¼ˆmin_freq, min_pmiç­‰ï¼‰
- éœ€è¦åˆ†æchunkçº§åˆ«çš„sparseå‘é‡ç”Ÿæˆæƒ…å†µ
- éœ€è¦è¯†åˆ«ç©ºsparseå‘é‡çš„chunkå¹¶ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
- éœ€è¦è°ƒç”¨LLMåšä¸“å®¶åˆ†æ

## 2. å·¥å…·æ¶æ„è®¾è®¡

### 2.1 æ ¸å¿ƒæ¨¡å—ç»“æ„
```
evaltool/
â”œâ”€â”€ analyze_sparse/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ analyze_sparse.py      # å‘½ä»¤è¡Œå…¥å£
â”‚   â”œâ”€â”€ sparse_analyzer.py     # ä¸»åˆ†æå™¨
â”‚   â”œâ”€â”€ bm25_manager.py        # BM25ç®¡ç†å™¨
â”‚   â””â”€â”€ chunk_processor.py     # Chunkå¤„ç†å™¨
```

### 2.2 ç±»èŒè´£åˆ†å·¥
- **AnalyzeSparse**: å‘½ä»¤è¡Œå‚æ•°è§£æå’Œä¸»æµç¨‹è°ƒåº¦
- **SparseAnalyzer**: æ ¸å¿ƒåˆ†æé€»è¾‘ï¼Œåè°ƒå„ç»„ä»¶
- **BM25Manager**: BM25æ¨¡å‹ç®¡ç†å’Œsparseå‘é‡ç”Ÿæˆ
- **ChunkProcessor**: Chunkæ•°æ®è§£æå’Œæ–‡æœ¬æå–

### 2.3 è®¾è®¡åŸåˆ™
- **å•ä¸€èŒè´£**: æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½
- **å¯æµ‹è¯•æ€§**: æ‰€æœ‰ç»„ä»¶éƒ½æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•
- **å¯å¤ç”¨æ€§**: æ ¸å¿ƒé€»è¾‘å¯è¢«å…¶ä»–å·¥å…·è°ƒç”¨
- **é…ç½®é©±åŠ¨**: æ”¯æŒç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶

## 3. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 3.1 å‚æ•°åŠ¨æ€è°ƒæ•´
```python
# æ”¯æŒä¸´æ—¶ç¯å¢ƒå˜é‡è¦†å†™ï¼Œä¸ä¿®æ”¹é»˜è®¤é…ç½®
os.environ['BM25_MIN_FREQ'] = '3'  # ä¸´æ—¶è°ƒæ•´æœ€å°é¢‘ç‡
os.environ['BM25_MIN_PMI'] = '2.0' # ä¸´æ—¶è°ƒæ•´æœ€å°PMI
```

### 3.2 Chunkæ•°æ®è§£æ
- æ”¯æŒ`data_vector_v3.py`æ ¼å¼çš„chunkæ–‡ä»¶
- è‡ªåŠ¨æå–chunkä¸­çš„æ–‡æœ¬å†…å®¹
- å¤„ç†å¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆmarkdown, txtç­‰ï¼‰

### 3.3 Sparseå‘é‡ç”Ÿæˆ
```python
# ä¸upsert.pyä¿æŒä¸€è‡´çš„sparseå‘é‡ç”Ÿæˆé€»è¾‘
bm25_manager = BM25Manager(user_dict_path=dict_path)
bm25_manager.fit(texts)
sparse_vector = bm25_manager.get_sparse_vector(text)
```

### 3.4 ç»Ÿè®¡åˆ†æ
- è¯æ±‡è¦†ç›–ç‡ç»Ÿè®¡
- ç©ºsparseå‘é‡chunkè¯†åˆ«
- è¯å…¸å¤§å°å’Œå‚æ•°å½±å“åˆ†æ
- è¯¦ç»†ç»Ÿè®¡æŠ¥å‘Šç”Ÿæˆ

### 3.5 LLMä¸“å®¶åˆ†æ
```python
# è°ƒç”¨OpenAI APIç”Ÿæˆä¸“ä¸šåˆ†ææŠ¥å‘Š
analysis_prompt = f"""
ä½œä¸ºNLPä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹sparseå‘é‡ç”Ÿæˆæƒ…å†µï¼š
- è¯å…¸å¤§å°: {dict_size}
- è¯æ±‡è¦†ç›–ç‡: {coverage_rate}%
- ç©ºsparseå‘é‡æ•°é‡: {empty_count}
- å½“å‰å‚æ•°: min_freq={min_freq}, min_pmi={min_pmi}
è¯·æä¾›æ”¹è¿›å»ºè®®ã€‚
"""
```

## 4. è¯„ä¼°æ–¹æ³•

### 4.1 è¯„ä¼°æŒ‡æ ‡
1. **è¯å…¸è´¨é‡æŒ‡æ ‡**
   - è¯å…¸å¤§å°ï¼šè¯æ±‡æ•°é‡
   - è¯æ±‡è¦†ç›–ç‡ï¼šchunkä¸­èƒ½è¢«è¯å…¸è¦†ç›–çš„è¯æ±‡æ¯”ä¾‹
   - å¹³å‡è¯æ±‡é•¿åº¦ï¼šçŸ­è¯­çš„å¹³å‡å­—ç¬¦æ•°

2. **Sparseå‘é‡è´¨é‡æŒ‡æ ‡**
   - ç©ºsparseå‘é‡æ¯”ä¾‹ï¼šæ— æ³•ç”Ÿæˆsparseå‘é‡çš„chunkå æ¯”
   - éé›¶å…ƒç´ æ•°é‡ï¼šsparseå‘é‡çš„ç¨€ç–åº¦
   - å‘é‡æƒé‡åˆ†å¸ƒï¼šæƒé‡å€¼çš„åˆ†å¸ƒæƒ…å†µ

3. **å‚æ•°æ•æ„Ÿæ€§æŒ‡æ ‡**
   - ä¸åŒå‚æ•°ä¸‹çš„è¯å…¸å¤§å°å˜åŒ–
   - å‚æ•°å¯¹è¯æ±‡è¦†ç›–ç‡çš„å½±å“
   - å‚æ•°å¯¹ç©ºsparseå‘é‡çš„å½±å“

### 4.2 è¯„ä¼°æµç¨‹
```bash
# 1. åŸºç¡€è¯„ä¼°
python3 -m evaltool.analyze_sparse.analyze_sparse \
  --chunk-file chunk_data.json \
  --dict-file dict/all_docs_dict_2507052104.txt

# 2. å‚æ•°è°ƒä¼˜è¯„ä¼°
BM25_MIN_FREQ=3 python3 -m evaltool.analyze_sparse.analyze_sparse \
  --chunk-file chunk_data.json \
  --dict-file dict/all_docs_dict_2507052104.txt

# 3. æ‰¹é‡å‚æ•°è¯„ä¼°
for min_freq in 1 2 3 4 5; do
  BM25_MIN_FREQ=$min_freq python3 -m evaltool.analyze_sparse.analyze_sparse \
    --chunk-file chunk_data.json \
    --dict-file dict/all_docs_dict_2507052104.txt
done
```

### 4.3 æŠ¥å‘Šæ ¼å¼
```json
{
  "timestamp": "2025-07-05 21:04:00",
  "parameters": {
    "min_freq": 3,
    "min_pmi": 3.0,
    "max_len": 6
  },
  "dictionary_stats": {
    "dict_size": 1250,
    "coverage_rate": 78.5,
    "avg_phrase_length": 4.2
  },
  "sparse_vector_stats": {
    "total_chunks": 1000,
    "empty_sparse_count": 0,
    "empty_sparse_rate": 0.0,
    "avg_nonzero_elements": 15.3
  },
  "llm_analysis": "ä¸“å®¶åˆ†æå»ºè®®ï¼šå½“å‰å‚æ•°é…ç½®åˆç†ï¼Œè¯å…¸å¤§å°é€‚ä¸­...",
  "recommendations": [
    "å»ºè®®ä¿æŒmin_freq=3çš„é…ç½®",
    "å¯ä»¥è€ƒè™‘é€‚å½“é™ä½min_pmiä»¥æé«˜è¦†ç›–ç‡"
  ]
}
```

## 5. æµ‹è¯•é©±åŠ¨å¼€å‘

### 5.1 æµ‹è¯•è¦†ç›–
- **å•å…ƒæµ‹è¯•**: æ¯ä¸ªæ ¸å¿ƒç±»éƒ½æœ‰å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹
- **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
- **è¾¹ç•Œæµ‹è¯•**: ç©ºæ•°æ®ã€æç«¯æ•°æ®ã€å¼‚å¸¸æ•°æ®æµ‹è¯•
- **å›å½’æµ‹è¯•**: ç¡®ä¿é‡æ„ååŠŸèƒ½ä¸å˜

### 5.2 æµ‹è¯•æ•°æ®
- ä½¿ç”¨é¡¹ç›®ä¸­çš„çœŸå®40kæ–‡æ¡£ä½œä¸ºæµ‹è¯•æ•°æ®
- é¿å…å‡­ç©ºåˆ¶é€ æ— æ•ˆæµ‹è¯•æ•°æ®
- ç¡®ä¿æµ‹è¯•åœºæ™¯ä¸å®é™…ä½¿ç”¨åœºæ™¯ä¸€è‡´

### 5.3 æµ‹è¯•ç»“æœ
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python3 -m test.test_sparse_analyzer
python3 -m test.test_bm25_manager
python3 -m test.test_chunk_processor

# æµ‹è¯•ç»“æœï¼šå…¨éƒ¨é€šè¿‡
........
----------------------------------------------------------------------
Ran 8 tests in 49.551s
OK
```

## 6. å·¥ç¨‹å®è·µ

### 6.1 ä»£ç è´¨é‡
- éµå¾ªPEP 8ç¼–ç è§„èŒƒ
- ä½¿ç”¨ç±»å‹æç¤ºæé«˜ä»£ç å¯è¯»æ€§
- å®Œæ•´çš„æ–‡æ¡£å­—ç¬¦ä¸²å’Œæ³¨é‡Š
- æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

### 6.2 é”™è¯¯å¤„ç†
- å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
- ä¼˜é›…çš„è¾¹ç•Œæƒ…å†µå¤„ç†
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### 6.3 é…ç½®ç®¡ç†
- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®
- æ”¯æŒé…ç½®æ–‡ä»¶
- å‚æ•°éªŒè¯å’Œé»˜è®¤å€¼å¤„ç†
- é…ç½®çƒ­æ›´æ–°æ”¯æŒ

## 7. ä½¿ç”¨æ•ˆæœ

### 7.1 é—®é¢˜è¯Šæ–­
- æˆåŠŸè¯†åˆ«äº†ç©ºsparseå‘é‡çš„æ ¹æœ¬åŸå› 
- å‘ç°BM25å‚æ•°é…ç½®è¿‡ä¸¥å¯¼è‡´è¯å…¸è¿‡å°
- é€šè¿‡å‚æ•°è°ƒä¼˜è§£å†³äº†sparseå‘é‡ç”Ÿæˆé—®é¢˜

### 7.2 å‚æ•°ä¼˜åŒ–
- å°†min_freqä»5é™ä½åˆ°3ï¼Œè¯å…¸å¤§å°ä»462å¢åŠ åˆ°1250
- è¯æ±‡è¦†ç›–ç‡ä»58%æå‡åˆ°78.5%
- ç©ºsparseå‘é‡æ•°é‡ä»100%é™ä½åˆ°0%

### 7.3 è´¨é‡æå‡
- ä¸Šä¼ æˆåŠŸç‡ä»0%æå‡åˆ°100%
- æ£€ç´¢è´¨é‡æ˜¾è‘—æ”¹å–„
- ç³»ç»Ÿç¨³å®šæ€§å¤§å¹…æå‡

## 8. ç»éªŒæ€»ç»“

### 8.1 æŠ€æœ¯ç»éªŒ
1. **å‚æ•°æ•æ„Ÿæ€§**: BM25å‚æ•°å¯¹sparseå‘é‡è´¨é‡å½±å“å·¨å¤§
2. **è¯å…¸è´¨é‡**: è¯å…¸å¤§å°å’Œè¦†ç›–ç‡æ˜¯sparseå‘é‡ç”Ÿæˆçš„å…³é”®
3. **è¾¹ç•Œå¤„ç†**: ç©ºæ•°æ®ç­‰è¾¹ç•Œæƒ…å†µéœ€è¦ç‰¹åˆ«å…³æ³¨
4. **ä¸€è‡´æ€§ä¿è¯**: è¯„ä¼°å·¥å…·å’Œä¸»æµç¨‹å¿…é¡»ä½¿ç”¨ç›¸åŒçš„é€»è¾‘

### 8.2 å·¥ç¨‹ç»éªŒ
1. **TDDå®è·µ**: å…ˆå†™æµ‹è¯•å†å†™ä»£ç ï¼Œç¡®ä¿è´¨é‡
2. **çœŸå®æ•°æ®**: ä½¿ç”¨çœŸå®æ•°æ®æµ‹è¯•ï¼Œé¿å…æ— æ•ˆæµ‹è¯•
3. **æ¨¡å—åŒ–è®¾è®¡**: å•ä¸€èŒè´£ï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤
4. **é…ç½®é©±åŠ¨**: æ”¯æŒçµæ´»çš„å‚æ•°è°ƒæ•´

### 8.3 é—®é¢˜è§£å†³ç»éªŒ
1. **æ ¹å› åˆ†æ**: æ·±å…¥åˆ†æé—®é¢˜æ ¹æœ¬åŸå› ï¼Œä¸åªçœ‹è¡¨é¢ç°è±¡
2. **å·¥å…·å¼€å‘**: å¼€å‘ä¸“ç”¨å·¥å…·è§£å†³ç‰¹å®šé—®é¢˜
3. **å‚æ•°è°ƒä¼˜**: ç³»ç»Ÿæ€§çš„å‚æ•°è°ƒä¼˜å’Œæ•ˆæœè¯„ä¼°
4. **è´¨é‡ä¿è¯**: é€šè¿‡æµ‹è¯•ç¡®ä¿ä¿®æ”¹çš„æ­£ç¡®æ€§

## 9. åç»­æ”¹è¿›

### 9.1 åŠŸèƒ½æ‰©å±•
- æ”¯æŒæ›´å¤šBM25å‚æ•°è°ƒæ•´
- å¢åŠ æ›´å¤šè¯„ä¼°æŒ‡æ ‡
- æ”¯æŒæ‰¹é‡å‚æ•°è¯„ä¼°å’Œå¯¹æ¯”
- é›†æˆåˆ°CI/CDæµç¨‹

### 9.2 æ€§èƒ½ä¼˜åŒ–
- æ”¯æŒå¤§è§„æ¨¡æ•°æ®è¯„ä¼°
- å¹¶è¡Œå¤„ç†å¤šä¸ªchunk
- ç¼“å­˜æœºåˆ¶å‡å°‘é‡å¤è®¡ç®—
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–

### 9.3 ç”¨æˆ·ä½“éªŒ
- æ›´å‹å¥½çš„å‘½ä»¤è¡Œç•Œé¢
- å¯è§†åŒ–æŠ¥å‘Šç”Ÿæˆ
- äº¤äº’å¼å‚æ•°è°ƒä¼˜
- å®æ—¶ç›‘æ§å’Œå‘Šè­¦

## 10. ç»“è®º

sparseå‘é‡è¯„ä¼°å·¥å…·çš„å¼€å‘æˆåŠŸè§£å†³äº†BM25å‚æ•°é…ç½®å’Œsparseå‘é‡ç”Ÿæˆè´¨é‡é—®é¢˜ã€‚é€šè¿‡TDDå¼€å‘ã€çœŸå®æ•°æ®æµ‹è¯•ã€æ¨¡å—åŒ–è®¾è®¡ç­‰å·¥ç¨‹å®è·µï¼Œç¡®ä¿äº†å·¥å…·çš„è´¨é‡å’Œå¯é æ€§ã€‚

è¯¥å·¥å…·ä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œè¿˜ä¸ºåç»­çš„sparseå‘é‡è´¨é‡è¯„ä¼°å’Œå‚æ•°è°ƒä¼˜æä¾›äº†å¼ºæœ‰åŠ›çš„æ”¯æŒã€‚å…¶è®¾è®¡ç†å¿µå’Œå®ç°æ–¹æ³•å¯ä»¥ä½œä¸ºå…¶ä»–è¯„ä¼°å·¥å…·å¼€å‘çš„å‚è€ƒã€‚ 