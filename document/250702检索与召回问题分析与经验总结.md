# 25-07-02 检索与召回问题分析与经验总结

## 1. 问题发现

### 1.1 召回结果出现串台
在实际的问答系统输出中，我们发现最终生成的答案中出现了不属于目标单位的能力、技能或描述。例如，查询“凯恩化身”时，答案中混入了其他单位的技能说明。

### 1.2 检索结果杂质多
通过分析召回的原始chunk，发现召回结果中混入了与目标实体无关的内容，导致答案生成时"串台"现象严重，影响了用户体验和答案准确性。


## 2. 问题分析

### 2.1 召回机制缺陷
- 传统的全局向量检索（vector_search）在召回时，无法保证只召回目标单位的内容。
- 由于单位描述、规则说明等内容在原文中分布广泛，向量检索容易召回到"距离""装备""规则"等通用描述，导致杂质信息混入。

### 2.2 chunk切片策略问题
- 早期的切片策略导致一个chunk中可能包含多个单位或多个规则，内容边界不清晰。
- 这样即使filter精准，召回的chunk本身也可能"串台"。


## 3. 解决方案探索

### 3.1 引入filter精准定位
- 我们尝试利用Pinecone的metadata filter功能，期望通过filter精准定位到目标实体的chunk。
- 具体做法是将单位名、技能名等结构化信息作为metadata字段，检索时用filter限定。

### 3.2 切片策略优化
- 针对串台问题，重构了切片逻辑，确保每个chunk只包含单一单位/技能/规则的内容。
- 切片时将所有标题（h1~h6）都写入metadata，便于后续多层级filter。

### 3.3 filter模糊查询受限
- 实践中发现Pinecone的filter不支持模糊匹配、正则、$contains等操作，只能精确匹配或$in列表匹配。
- 这导致用户query与metadata不能模糊对齐时，filter无法命中。

### 3.4 标题全量入库
- 为提升filter命中率，将所有层级标题（h1~h6）都作为metadata字段写入。
- 检索时用$or组合，支持在任意层级标题中匹配实体名。


## 4. 新问题与持续优化

### 4.1 query与标题不完全匹配
- 实际测试发现，用户输入的query与文档标题往往不能一一对应（如"凯恩化身" vs "凯恩化身 AVATAR OF KHAINE"）。
- 这导致filter依然无法命中目标chunk，召回结果数量少或为0。

### 4.2 解决思路
- 建立实体标准化映射表，将简写、别名、英文名全部映射到标准标题。
- 检索时对用户query做标准化处理，或在filter中用$in/$or同时匹配多种写法。
- 若filter召回不足，再用全局向量检索补充，融合两种结果。


## 5. 经验总结

1. **召回杂质问题本质在于切片和检索策略的协同**，单独优化任一环节都难以彻底解决串台。
2. **filter能极大提升相关性，但受限于精确匹配，需配合实体标准化和多层级metadata设计。**
3. **切片粒度和边界设计是基础，chunk内容必须单一、边界清晰。**
4. **Pinecone filter不支持模糊/正则，所有模糊需求都要转为结构化list和标准化映射。**
5. **混合检索（filter+全局向量）是提升召回率和精度的有效方案。**
6. **持续测试和分析实际召回内容，是发现问题和优化方案的关键。**

---

本经验总结为后续检索系统的设计和优化提供了系统性参考。 