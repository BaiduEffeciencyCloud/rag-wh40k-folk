# 基于多级标题字段的切片重构方案

## 背景

在战锤40K规则RAG问答系统的文档切片与检索过程中，曾出现因切片metadata未能准确反映文档多级标题结构，导致内容归属混乱、召回串台等问题。为解决此类问题，需要在切片时完整保留文档的层级结构信息。

## 目标

- 切片时将文档的1-6级标题分别作为独立字段写入每个chunk的metadata。
- 检索与召回时可直接利用这些字段进行精确定位和过滤，彻底杜绝跨section串台。
- 方案实现简单、直观，便于调试和后续扩展。

## 设计细节

### 1. 标题栈维护
- 切片时维护一个长度为6的标题栈（h1~h6）。
- 每遇到新标题，更新对应级别及其下级为空。
- 例如遇到h3，则h3赋新值，h4~h6清空，h1~h2保持不变。

### 2. metadata结构
- 每个chunk的metadata包含如下字段：
  - `h1`：一级标题内容（如无则为空）
  - `h2`：二级标题内容（如无则为空）
  - `h3`：三级标题内容（如无则为空）
  - `h4`、`h5`、`h6`同理
- 例如：
```json
{
  "h1": "军队规则",
  "h2": "殊途同归 DISPARATE PATHS",
  "h3": "技能描述",
  "h4": "",
  "h5": "",
  "h6": ""
}
```

### 3. 切片生成
- 每生成一个chunk时，将当前标题栈快照写入metadata。
- 正文内容归属到当前标题栈所指的层级。

### 4. 检索与召回
- 检索时可直接用metadata的h1~h6字段做过滤、聚合、展示。
- 可实现"只召回某一级标题下内容"或"多级标题精确定位"。

## 实现建议

- 切片主逻辑无需大改，仅需在每次遇到标题时维护标题栈，并在chunk生成时写入metadata。
- 兼容现有的chunk结构，便于平滑迁移。
- 可在`data_vector_v3.py`等切片脚本中实现。

## 优缺点分析

### 优点
- 实现简单，结构直观，调试方便。
- 层级信息完整，便于后续扩展和结构校验。
- 检索友好，支持多级标题精准召回。
- 兼容性好，对现有流程影响小。

### 缺点
- metadata字段较多，部分chunk字段为空，但对性能和存储影响极小。
- 结构表达不如嵌套对象优雅，但实际工程中高效实用。

## 兼容性与扩展性

- 方案与现有chunk结构兼容，可平滑迁移。
- 后续如需更复杂的结构（如嵌套树），可基于这些字段进行重构。
- 可结合结构校验器，确保切片层级信息正确。

## 总结

本方案以"够用且稳妥"为原则，将1-6级标题分别作为metadata字段，完整保留文档层级结构，极大提升切片与召回的准确性和可维护性。适合当前阶段的工程实践，后续可按需升级。 